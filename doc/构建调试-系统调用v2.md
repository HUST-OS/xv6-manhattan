# **一些系统调用的实现**
现阶段，我们给 xv6-k210 增加了不少系统调用，以支持复杂应用的运行。本文大致记录了其中一些系统调用的实现过程、
实现思路以及遇到的问题等，同时也对一些系统调用做一些说明。对于一些相对简单的系统调用，本文可能不会详细讨论。
与某个模块相关的系统调用（如 `mmap` 等）可能已在其他文档中有过说明，此处也不再记录了。
<br>
<br>

## `writev`/`readv` 系统调用
相比常用的 `write`/`read` 调用，它们的名字后多了个 `v`，其取向量之意，相当于多次使用了 `write`/`read`，
对多个缓冲区进行读写。本以为这两个系统调用很好实现，只要多次调用 `write`/`read` 的底层函数就行。一开始，
我们确实这么做了，运行起来还可以，但在运行 lua 的时候就遇到了问题，它在调用 `readv` 后，似乎对输入反应很迟钝，
大致表现为有时对敲入的回车键不予以反应。

所幸我们很快发现了问题。如果是对普通文件调用 `writev`/`readv`，那么表现就很正常，但如果是对标准输入输出设备、
管道文件使用，`readv` 就表现得有些异常。这是因为，读真正意义上的文件时，其内容是静态的，读完了就可以返回；
但是对于标准输入输出和管道，当其中没有内容时，底层的读函数会导致阻塞，`readv` 多次调用 `read` 的相同底层函数，
就会导致多次阻塞，这显然不合理。

由于文件的类型不同，底层的实现也不同，因此需要在 vfs 的文件操作抽象中增加 `writev`/`readv` 接口。对磁盘文件，
其实现确实可以复用 `write`/`read` 的底层实现，但设备和管道的 `readv` 就必须要重写了。它们的实现与普通读写类似，
只需注意当一个缓冲区填满后，要切换到下一个缓冲区，同时要保证 `readv` 最多只阻塞一次。

## `renameat2` 系统调用
这是用于重命名文件的系统调用，也可以用于移动文件。在支持 vfs 之前，我们曾为 xv6-k210 实现过类似的系统调用，
但后来由于与 vfs 不兼容，被废除了，需要重新实现。这其实是一个比较复杂的系统调用，需要处理这些情况：
+ 被移动的文件是否存在与同一个存储设备上；
+ 移动文件时，需要判断目标文件是否已存在；
+ 移动目录时，目标目录不能是被移动目录的子目录，否则就绕成了一个环；
+ 移动目录时，若已经存在目标目录且其为空，则将其覆盖。

在具体实现中，还会涉及锁的问题。具体来说，至少要为被移动的文件和要移动到的目录文件加锁，以防止被移动文件被删移，
或目标目录下同时建立新同名文件。如果目标目录下已存在同名文件，则还需要对该文件进行判断，这也需要锁。显而易见，
这其中就可能产生死锁问题，比如两个目录操作，分别想将一个目录重命名为另一个目录的文件名。比较简单的解决方案是，
支持锁的尝试获取操作，如果发现请求的资源不可用，则直接失败返回，而不是一直等待。

如果一切准备工作都通过了检测，就可以通过 vfs 接口调用底层文件系统实现的重命名函数了，在当且情况下也就是 FAT32 
文件系统的驱动来负责具体的磁盘逻辑操作。该系统调用或许还涉及到一些我们没有考虑到的复杂情况，只有发现后才能完善了。

## `fcntl` 系统调用
只实现了 busybox 需要的部分功能，实际上与 `dup3` 的功能类似，但也有所差别。

## `getuid` 等系统调用
目前 xv6-k210 暂不支持多用户功能，因此这类系统调用直接返回 0，表示 root 用户。

## `exit_group` 系统调用
目前 xv6-k210 暂不支持多线程，因此一个进程中只有一个线程，此时 `exit_group` 和 `exit` 等价。假设有多线程，
`exit_group` 该如何实现呢？初步认为，可以标记该进程内的所有线程为退出态，并唤醒这些线程，如果其中有线程还在运行，
那么当它们的时间片结束切回内核态，或是由于异常、中断等原因内陷时，才会把它们结束。等到所有线程都真正退出后，
再执行原有的 `exit` 逻辑。

**更新**
## `pselect` 系统调用
该功能与 `ppoll` 本质上是相同的，




## 一些未完善的工作

### `ppoll` 功能
这是一个十分重要的功能，不过我们还没有设计出良好的数据结构来很好地支持它。

### proc fs 功能
Linux 中有一个 `/proc` 目录，里面存放了各种和进程相关的信息。该目录以及其中的内容并不是真实的文件，而是虚拟的，
也就是一个挂载于 `/proc` 目录的基于内存的 proc 文件系统，给用户提供了获取系统信息的途径。该功能需要 vfs 的支持，
不过我们还没能完全实现它，只是提供了一小部分功能。


