# 总言，关于比赛的一些话

陆思彤 <sitong-lu@qq.com>
刘一鸣 <artyomliu@foxmail.com>

## 1. 比赛的准备与调研

在开始比赛之前，我们对各个高校的教学OS进行了研究。当时主要考量的OS包括清华大学的rCore,uCore，
MIT的xv6-riscv以及华中科技大学的PKE。在结合了各个方面的考量后，我们选择了MIT的xv6作为参加比赛的
平台，并开始着手将xv6移植到k210开发板上。

作为MIT操作系统课程的实验平台，xv6-riscv拥有完备的实验文档说明，同时采用简单易懂的C语言进行编写，
相对来说上手难度较低，且当时队伍里的同学基本上都有xv6-riscv实验的经验。因此xv6-riscv成为了我们的
第一选择。

## 2. 系统框架

Xv6-k210 基于 MIT 的 Xv6-riscv 操作系统的总体框架，对各模块进行了改进或重写，保留了宏内核的特征。
从总体功能角度看，xv6-k210 是多核多进程的分时系统，具有分时调度、内存管理、文件系统等基本功能，
并且支持部分 POSIX 接口的系统调用，可以运行静态链接的 ELF 可执行程序。
从系统架构上看，xv6-k210 内核主要分为这些部分：
+ **进程模块**
    + 进程调度与进程切换
    + 进程的创建与释放
    + 进程资源管理
    + 进程信号的管理
    + 同步与互斥
    + 进程亲缘关系树的组织
+ **文件系统模块**
    + 虚拟文件系统
    + FAT32 文件系统驱动
    + 管道、设备文件
    + 磁盘缓冲层
+ **内存管理模块**
    + 内存页面管理
    + 小块内存管理
    + 虚拟地址空间管理
    + 缺页处理机制
+ **内陷处理模块**
    + 系统调用
    + 用户异常
    + 设备中断
    + 时钟中断
+ **硬件抽象模块**
    + 磁盘驱动
    + 串口终端驱动
    + DMA 等外设接口的驱动

各个模块之间分工明确，相辅相成，共同支持内核的良好运作。

## 3. 开发计划与开发中的重要进展

开发过程中的重大里程碑包括
- 支持k210平台的时钟、外部中断
- 实现k210平台的SD卡驱动
- 为xv6-k210提供FAT32文件系统支持
- 通过软件中断代理的方式实现在S态处理xv6-k210的键盘输入与DMA带来的外部中断
- 实现了VFS用于支持不同的文件设备
- 设计实现了第一批比赛要求的Syscall，并顺利通过了初赛
- 为xv6-k210实现了内核中的动态内存分配器
- 在动态内存分配器的前提下，对文件系统代码进行了重写
- 实现了**COW（Copy on Write）**、**Lazy Allocation**等一系列内存优化策略
- 使用了新的内存映射策略，使得用户页表和内核页表能够使用相同的内存存储，极大地提高了页表的内存占用
- 重写了xv6-riscv的进程调度器，实现了基于队列的动态的进程管理策略
- 实现了复赛要求的Syscall，实现了对**busybox**的支持
- 使用Rust重新实现了RustSBI，并作为新的SBI项目PsicaSBI进行维护
- 对文件系统与底层SD卡驱动进行了重写，实现了异步的SD卡写策略

## 4. 作品特征描述

作为脱胎于MIT xv6-riscv的项目，xv6-k210在整体的架构上与xv6-riscv基本保持一致，但也仅此而已。在开发中我们
不断地对xv6-riscv的代码进行重写，以期获得更优的性能表现。如第3节中所描述的，我们为xv6加入了如动态内存分配、
COW或是Lazy Allocation这样的原系统所不具有的功能，并提供了FAT32这样的更加实用的文件系统的支持。同时，系统中
的调度器、内存管理策略、文件系统等都几乎被完全重写。

尽管xv6-k210作为面向k210平台而开发的内核，但在队员们的努力下我们实现了QEMU平台上的仿真模拟。在大多数硬件无关的
开发场景下，我们可以先在QEMU平台进行调试，待测试充分后再烧写至开发板进行测试。基于QEMU的仿真测试极大地加快了各种
内核组建的开发速度。

也是为了能够更好地对系统进行调试，我们在xv6-k210中建立了一个相对完备的调试机制，这一机制允许开发者使用各种宏在系统
中进行输出和断言调试，并可以在编译时通过选项精准地开启/关闭部分文件的调试信息。这些文件依托于C语言的宏定义实现，并
保存在`include/utils/debug.h`中以供使用。

## 5. 目录与文件描述

原本的xv6-riscv项目是没有一个明确的文件目录管理的。在开发的过程中，为了开发的方便，我们对原有的文件
进行了整理，得到了如今的布局。总的来说分为用于保存头文件的`include/`和用于保存C程序的`kernel/`。
其中，`kernel/`内的各文件夹含义如下
- `fs/` 文件系统相关的各个文件
- `hal/` 硬件抽象层
- `mm/` 内存管理，包括虚拟内存和物理内存
- `sched/` 进程调度与信号
- `sync/` 内核中的锁，用于支持各种同步机制
- `syscall/` 各个syscall的处理函数
- `trap/` 内陷处理，用于处理各种异常（Exception）与中断（Interrupt）
- `utils/` 一些实用的平台无关的辅助函数
而`include/`中的布局与含义和`kernel/`中类似，在此不表。

## 6. 分工与协作

刘一鸣：
主要负责进程调度器与信号机制的开发与调试工作，同时也主要参与SD卡驱动、trap处理以及内存分配器的开发。同时还
使用Rust实现了PsicaSBI为系统提供来自M态的支持。广泛参与内核的调试工作。

陆思彤：
主要负责文件系统部分的设计与实现，包括虚拟文件系统、FAT32 驱动等，还参与内存分配器、用户空间管理等模块的设计。
设计了页表映射策略，实现缺页处理机制、写时复制和懒分配机制。还对磁盘 I/O 策略做了一些优化。广泛参与内核的调试工作。

李永康：
参与设计与实现用户空间管理、内存映射等模块。

## 7. 心得与收获

刘一鸣：说实话，通过这次比赛，我对于OS内核开发的理解大大地加深了。这整个流程让我充分地理解了OS是如何
运行的，如何实现对底层硬件的支持，以及如何实现用户进程之间的调度管理。我在项目中主要负责调度器、信号、
SBI以及底层驱动的开发工作，这些工作让我对于手里的硬件有了更多的理解，尤其是对于SD卡的驱动。我很高兴能
够有机会参与这次的比赛。

陆思彤：
经历了若干个月的艰苦奋战，我们终于来到了终点线。回顾过去这段历程，我们翻山越岭、披荆斩棘，提出各种想法并尝试实现，
遇到各种困难并艰难克服，不得不说，这是一段十分难得十分可贵的经历。刚刚学完操作系统理论课的我，还是似懂非懂的状态。
参加比赛后，在老师与同学的引领下，开始参与一些代码实践，学习 RISC-V 体系结构的相关知识，一步一步地了解内核实现原理。
到最后，我已经可以自如地在内核上动刀，尝试将自己的想法转化为实践。在开发过程中，我增强了自己的代码能力、调试能力，
也学会了如何进行团队协作开发。总而言之，这次比赛经历可以使我受益终生！

## 致谢

项目能够走到今天这一步，每一位老师、同学的帮助都必不可少。在此，我们非常感谢来自华中科技大学的邵志远老师的指导工作，
以及华科同学车春池、洛佳等人的大力支持。我们对各位老师和同学们的工作表示由衷地感谢。